<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>StartCraft 2 Private League</title>

        <style>
        #container {display:flex; flex-direction:column; height:100%; width:100%;}
        #output {width:100%}

        #player {display:flex; flex-direction:column; width:400px;}

        .row {display:flex; flex-direction:row;}
        .col1, .col3, .col4, .col5 {width: 50px;text-align:center;}
        .col2 {width: 200px;}
        .winner_back {background-color : green}
        .loser_back {background-color : red}

        #match {margin-top: 40px;}

        .week {display:flex; flex-direction:row; justify-content:space-around;}
        .highlighted {background: #afa; }

        .played, .unplayed, .ongoing, .date {display:flex; flex-direction:column; justify-content:space-around; width:100px; height:80px; margin:5px;  position: relative; }
        .normal_player, .winner, .loser {text-align: center; border:none; width: 100%;margin:0px;padding:0px;}

        .score { display:flex; flex-direction:column; justify-content:space-around; height:100%;}
        .score div { display:flex; flex-direction:row; justify-content:space-around;}

        .info {
            display: none;
            position: absolute;
            width: 100px;
            height: 80px;
            left: 100px;
            border: 2px solid #000;
            border-left: 0px;
            background-color: #fff;
            z-index: 1;
        }
        .ongoing .info {
            background-color: #cc0;
        }

        .winner {color : green}
        .loser {color : red}
        span.winner, span.loser {10px;}

        .played {border: 2px solid #000; }
        .unplayed {border: 2px dashed #aaa; }
        .ongoing {border: 2px solid #000; background-color: #cc0;}

        .played:hover, .ongoing:hover {
            border-right: 0px;
            padding-right: 2px;
        }

        .played:hover .info, .ongoing:hover .info {
            display:block;
        }

        #popup {
            position: absolute;
            top: -10px;
            left: -10px;
            background-color: #fff;
            border: 1px solid #ccc;
            width: 300px;

            border-radius:5px;

            z-index: 3;
        }

        .row {display:flex; flex-direction:row; justify-content:flex-end;}

        #popup label {
            flex-grow:50;
        }

        #popup div {
            margin:15px;
        }

        .hidden {
            display: none;
        }

        .active {
            display: block;
        }

        #error_output {
            color:#f00;
        }
        </style>
    </head>
    <body>
        <div id="container">
            <h2>StartCraft 2 Private League - Season 2</h2>

            <div id="output">
                <div id="player"></div>

                <div id="match"></div>
            </div>
        </div>

        <div id="popup" class="hidden">
            <datalist id="race">
                <option value="Terran"></option>
                <option value="Zerg"></option>
                <option value="Protoss"></option>
            </datalist>

            <div class="row">
                <label id="first_player_label" for="first_player_race_input"></label>
                <input id="first_player_race_input" name="first_player_race" list="race" onfocus="this.value=''"/>
                <input type="radio" id="first_player_win_radio" name="first_player_won" value="true" checked />
            </div>
            <div class="row">
                <label id="second_player_label" for="second_player_race_input"></label>
                <input id="second_player_race_input" name="second_player_race" list="race" onfocus="this.value=''"/>
                <input type="radio" id="second_player_win_radio" name="first_player_won" value="false" />
            </div>
            <div class="row">
                <label id="duration_label" for="duration_text">Spieldauer</label>
                <input type="text" id="duration_text" name="duration" value="0:00" />
            </div>
            <div class="row">
                <div id="error_output"></div>
            </div>
            <div class="row">
                <input type="button" id="submit" name="game_submit" value="Add" style="margin-right:5px" onclick="addGame()"/>
                <input type="button" id="cancel" name="game_cancel" value="Cancel" onclick="hidePopup()"/>
            </div>
        </div>

        <script>
            var player = document.querySelector("#player");
            var match = document.querySelector("#match");
            var popup = document.querySelector("#popup");

            var wsUri = "ws://[[ADDR]]/";
            var websocket = new WebSocket(wsUri);

            var reg = /^([1-9]?[0-9]):([0-5][0-9])$/;

            websocket.onmessage = function(e) {
                var league = JSON.parse(e.data);

                player.innerHTML = '';
                match.innerHTML = '';

                var gpw = Math.floor(league.players.length / 2);

                var score = []
                league.players.forEach(element =>
                    score.push({
                        "name":element.name,
                        "win":0,
                        "loss":0}));

                league.matches.forEach(function(element,index) {
                    var last = match.lastChild;

                    if (last == null) {
                        match.insertAdjacentHTML("beforeend", "<div class='week'></div>");
                        last = match.lastChild;
                    } else if (last.childElementCount == gpw) {
                        match.insertAdjacentHTML("beforeend", "<div class='week'></div>");
                        last = match.lastChild;
                    }

                    class_name = "unplayed";
                    first_player_class = "normal_player";
                    second_player_class = "normal_player";
                    if (element.games.length > 0) {
                        first_player = 0;
                        second_player = 0;
                        element.games.forEach(game => {
                            if(game.first_player_won) {
                                first_player++;
                            } else {
                                second_player++;
                            }
                        });


                        if (first_player >= 2 && first_player > second_player) {
                            class_name = "played";
                            first_player_class = "winner";
                            second_player_class = "loser";
                        } else if (second_player >= 2 &&  second_player > first_player) {
                            class_name = "played";
                            first_player_class = "loser";
                            second_player_class = "winner";
                        } else {
                            class_name = "ongoing";
                        }
                    }

                    if (class_name == "played") {
                        var winner = element.players[1];
                        var loser = element.players[0];
                        if (first_player_class = "winner") {
                            var buf = winner;
                            winner = loser;
                            loser = buf;
                        }
                        score[winner]["win"]++;
                        score[loser]["loss"]++;
                    }

                    var info = "";
                    if (class_name != "unplayed") {
                        var p1_races = "";
                        var p2_races = "";
                        element.games.forEach(game => {
                                var first = "loser";
                                var second = "loser";
                                if (game.first_player_won) {
                                    first = "winner";
                                } else {
                                    second = "winner";
                                }

                                p1_races = p1_races + "<span class='"+first+"'>" + game.races[0].charAt(0)+ "</span>";
                                p2_races = p2_races + "<span class='"+second+"'>" + game.races[1].charAt(0)+ "</span>";
                        });
                        info = "<div class='info'> <div class='score'><div>"+ p1_races +"</div><div>"+ p2_races +"</div> </div></div>\n";
                    }

                    last.insertAdjacentHTML("beforeend", "<div class='" + class_name + "'><div class='"+first_player_class+"'>" + league.players[element.players[0]].name + "</div><div class='"+second_player_class+"'>" + league.players[element.players[1]].name + "</div>"+info+"</div>");
                    var last_match = last.lastChild;
                    last_match.addEventListener("click", openPopup, true);
                    last_match.addEventListener("contextmenu", openContext);
                });

                var week_number = getWeekNumber();

                var idx = week_number - league.start_week - 1;
                var weeks = document.getElementsByClassName("week");
                if (idx < 0) {
                    weeks.item(0).className="week highlighted";
                } else if (idx < weeks.length) {
                    weeks.item(idx).className="week highlighted";
                }

                for (var i = 0; i < weeks.length; i++) {
                    var analysis = getWeekAnalysis(league.start_week + i + 1);
                    weeks[i].insertAdjacentHTML("afterbegin",
                        "<div class=date>" +
                        dateToString(analysis["start_date"]) + " - " +
                        dateToString(analysis["end_date"]) + "</div>");
                };

                score.sort(function(b,a) {
                    if (a["win"] < b["win"] ) {
                        return -1;
                    } else if (a["win"] > b["win"]) {
                        return 1;
                    } else {
                        if (a["loss"] > b["loss"]) {
                            return -1;
                        } else if (a["loss"] < b["loss"]) {
                            return 1;
                        } else {
                            return 0;
                        }
                    }
                });

                console.log(score);

                //league.players.forEach(element =>
                //    player.insertAdjacentHTML("beforeend", "<div>" + element.name + "</div>"));

                score.forEach(function(element,idx) {
                    player.insertAdjacentHTML("beforeend",
                        "<div class='row'><div class='col1'>" + (idx+1) + "</div>" +
                        "<div class='col2'>" + element["name"] + "</div>" +
                        "<div class='col3'>" + (element["win"]+element["loss"]) + "</div>" +
                        "<div class='col4'>" + element["win"] + "</div>" +
                        "<div class='col5'>" + element["loss"] + "</div></div>")
                    });
                rows = player.getElementsByClassName("row");
                rows[0].className += " winner_back";
                rows[(rows.length - 1)].className += " loser_back";
                player.insertAdjacentHTML("afterbegin",
                        "<div class='row'><div class='col1'> # </div>" +
                        "<div class='col2'> Name </div>" +
                        "<div class='col3'> Sp </div>" +
                        "<div class='col4'> S </div>" +
                        "<div class='col5'> N </div></div>");

            };

            // Thx Stackoverflow
            function getWeekNumber(){
                var d = new Date();
                var dayNum = d.getUTCDay() || 7;
                d.setUTCDate(d.getUTCDate() + 4 - dayNum);
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
            };

            function dateToString(date) {
                return date.getDate() + "." + (date.getMonth() + 1) + ".";
            }

            function getWeekAnalysis(week) {
                var yearStart = new Date(Date.UTC((new Date()).getUTCFullYear(),0,1));
                var days_to_monday = (yearStart.getUTCDay() + 6) %7;
                yearStart.setDate(yearStart.getDate() - days_to_monday);
                var startDate = new Date(yearStart);
                var endDate = new Date(yearStart);
                startDate.setDate(startDate.getDate() + (7 * (week - 1)) );
                endDate.setDate(endDate.getDate() + (7 * week - 1));
                return {
                    "start_date": new Date(startDate),
                    "end_date": new Date(endDate),
                    };
            }

            function openPopup(e) {
                if (popup.className == "active") {
                    return;
                }

                this.appendChild(popup);
                document.getElementById("error_output").innerHTML = "";
                // TODO check size and make correct positioning
                popup.className="active";
                var inner = this.innerText.split("\n");
                document.getElementById("first_player_label").innerHTML= inner[0];
                document.getElementById("second_player_label").innerHTML= inner[1];
            }

            function openContext(e) {
                console.log(this);
                var inner = this.innerText.split("\n");
                if (confirm("Delete the games of the match '" +inner[0]+" vs. "+inner[1]+"'?")) {
                    json = JSON.stringify({"RemoveGames":{
                    "player1": inner[0],
                    "player2": inner[1],
                    }});
                    websocket.send(json);
                }
                e.preventDefault();
                return false;
            }

            function hidePopup() {
                popup.className = "hidden";
            }

            function addGame() {
                // Control checks:
                var race1 = document.getElementById("first_player_race_input").value;
                var race2 = document.getElementById("second_player_race_input").value;
                var time = document.getElementById("duration_text").value;
                var match = reg.exec(time);

                var error = document.getElementById("error_output");

                if (document.querySelector("#race option[value='" + race1 + "']") == null) {
                    error.innerHTML = "Rasse für Spieler 1...";
                    return;
                }
                if (document.querySelector("#race option[value='" + race2 + "']") == null) {
                    error.innerHTML = "Rasse für Spieler 2...";
                    return;
                }
                if (match == null) {
                    error.innerHTML = "Spieldauer...";
                    return;
                }

                json = JSON.stringify({"AddGame":{
                    "first_player_win": document.querySelector('input[name="first_player_won"]:checked').value == "true",
                    "player1": [document.getElementById("first_player_label").innerText,
                                race1.charAt(0).toLowerCase()],
                    "player2": [document.getElementById("second_player_label").innerText,
                                race2.charAt(0).toLowerCase()],
                    "duration_min" : parseInt(match[1]),
                    "duration_sec" : parseInt(match[2])
                }});
                websocket.send(json);
                hidePopup();
            }

        </script>
    </body>
</html>